# -----------------------------------------------------------------------------
# pre: init

# drop HID
echo "{{ device.id }}" > /etc/hardware.id

# create logflume script
cat <<"EOS" > /tmp/logflume
#!/bin/sh
LOGFILE=$1
LOGHOST=${2:-logflume}
LOGPORT=${3:-6650}
LCLHOST="{{ device.id }}"

while [ ! -e "$LOGFILE" ]; do
  sleep 1s
done && (
  tail -n 10000 -f "$LOGFILE" |
  while read line; do
    echo "[$(date +%s)] $LCLHOST: $line"
  done |
  while true; do
    nc $LOGHOST $LOGPORT > /dev/null 2>&1
    sleep 1s
  done
) &

EOS

chmod +x /tmp/logflume

# setup logging
/tmp/logflume /tmp/anaconda.log logflume.{{ device.properties.site }}.outbrain.com
