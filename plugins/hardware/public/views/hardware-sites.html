
<div class="container-fluid">
  <div class="row-fluid">
    <div class="span12">
      <h1>Datacenters</h1>
      <button class="btn btn-success pull-right" ng-click="reload()"><i class="icon-refresh icon-white"> </i> Reload</button>
      <br />
      <br />

      <tabs>
        <pane ng-repeat="site in sites | orderBy:0" heading="{{ site | uppercase }}">
          <div class="container-fluid widget-pane">
            <div class="row-fluid">
              <div class="span4">
                <div class="widget-title">Site Overview</div>

                <div class="widget-content">
                  overview
                </div>
              </div>

              <div class="span4">
                <div class="widget-title">Contact Information</div>

                <div class="widget-content">
                  overview
                </div>
              </div>

              <div class="span4">
                <div class="widget-title">Services</div>

                <div class="widget-content">
                  overview
                </div>
              </div>
            </div>
          </div>

          <h2>Racks</h2>

          <div ng-hide="opt.loading">
            <div>
              <button class="btn" ng-disabled="editRack" ng-click="editRack={site:site,vendor:{}}"><i class="icon-plus"> </i> Add Rack</button>
              <button class="btn" ng-show="opt.view=='front'" ng-click="opt.view='rear'"><i class="icon-chevron-right"> </i> Front View</button>
              <button class="btn" ng-hide="opt.view=='front'" ng-click="opt.view='front'"><i class="icon-chevron-left"> </i>Rear View</button>
              <br />
              <br />
            </div>

            <div class="container-fluid widget-pane" ng-hide="racks[site].length == 0">
              <div class="row-fluid">
                <div class="span3 rack" ng-repeat="rack in racks[site] | orderBy:'name'">
                  <div class="widget-title">
                    {{ rack.name }}
                    <span ng-show="rack.description">&ndash; {{ rack.description }}</span>

                    <span class="pull-right">
                      <span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
                      <span title="Edit this rack" ng-click="editRack=rack">
                        <i class="icon-pencil"> </i>
                      </span>

                      <span title="Delete this rack definition" rest="/api/hardware/rack/{{site}}/{{rack.name}}" rest-method="delete" rest-success="reload()">
                        <i class="icon-remove"> </i>
                      </span>
                    </span>
                  </div>

                  <table style="width:100%">
                    <tbody ng-repeat="unit in rack.units" class="unit" ng-click="opt.current_unit={site:site,rack:rack,unit:unit}">
                      <tr ng-repeat="u in unit.unit" ng-switch on="$index">
                        <td class="gutter">{{ u }}</td>
                        <td class="info {{ unit.nodes &amp;&amp; 'occupied' || 'empty' }}" ng-switch-when="0" rowspan="{{ unit.height }}">
                          <div width="100%" ng-show="unit.nodes">
                            <div
                              ng-show="unit.physical.layout.slots.order[opt.view || 'default']"
                              class="
                                slot
                                {{ ((($index+1) % (unit.physical.layout.slots.count / unit.physical.layout.slots.rows)) == 0) &amp;&amp; 'endcap' }}
                                {{ ($index < unit.physical.layout.slots.columns) &amp;&amp; 'toprow' }}
                              "
                              style="width: {{ 95.0 / unit.physical.layout.slots.columns }}%"
                              ng-repeat="slot in unit.physical.layout.slots.order[opt.view || 'default']"
                            >
                              <!-- physical info present, non-empty -->
                              <span class="status" ng-hide="unit.nodes[slot-1].empty">
                                <label class="label label-{{ unit.nodes[slot-1].status || 'unknown' }}">{{ slot }}</label>
                              </span>

                              <!-- physical info present, empty -->
                              <span class="status" ng-show="unit.nodes[slot-1].empty">
                                <label class="label label-inverse">{{ slot }}</label>
                              </span>


                              <br ng-show="(($index+1) % unit.physical.layout.slots.rows) == 0">
                            </div>

                            <span
                              ng-hide="unit.physical.layout.slots.order[opt.view || 'default']"
                              style="width: 95%"
                              ng-repeat="node in unit.nodes"
                            >
                              <!-- physical info absent, non-empty -->
                              <span class="status">
                                <label class="label label-{{ node.status || 'unknown' }}">{{ node.properties.slot || '&nbsp;' }}</label>
                              </span>
                            </span>
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="center" ng-show="racks[site].length == 0">
              <h2>No racks defined</h2>
              <br />
              <p>
                Click the <button class="btn" ng-disabled="editRack" ng-click="editRack={site:site}"><i class="icon-plus"> </i> Add Rack</button> button to create a new rack definition.
              </p>
            </div>
          </div>

          <div ng-show="opt.loading" class="center">
            <img src="/img/loading.gif" title="Current Setting: Thunderdark" />
            <h3>Loading...</h3>
          </div>

          <div class="modal" ng-show="editRack">
            <div class="modal-header">
              <h3>Rack Editor</h3>
            </div>

            <div class="modal-body">
              <form class="form-horizontal">
                <div class="control-group">
                  <label class="control-label" for="name">Site</label>
                  <div class="controls">
                    <input disabled type="text" ng-model="editRack.site"></input>
                  </div>
                </div>

                <div class="control-group">
                  <label class="control-label" for="name">Rack Number</label>
                  <div class="controls">
                    <input type="text" id="name" ng-model="editRack.name" placeholder="e.g.: 101"></input>
                  </div>
                </div>

                <div class="control-group">
                  <label class="control-label" for="name">Height</label>
                  <div class="controls">
                    <input type="text" id="height" ng-model="editRack.height" placeholder="e.g.: 42"></input>
                  </div>
                </div>

                <h4>Vendor Information</h4>

                <div class="control-group">
                  <label class="control-label" for="name">Vendor Rack Name</label>
                  <div class="controls">
                    <input type="text" id="height" ng-model="editRack.vendor.name"></input>
                  </div>
                </div>

                <div class="control-group">
                  <label class="control-label" for="name">Rack Label</label>
                  <div class="controls">
                    <input type="text" id="height" ng-model="editRack.vendor.name"></input>
                  </div>
                </div>

                <div class="control-group">
                  <label class="control-label" for="name">Vendor Location</label>
                  <div class="controls">
                    <input type="text" id="height" ng-model="editRack.vendor.contact_id" typeahead="c.id as (c.name+' '+c.vendor_site) for c in contacts | filter:$viewValue"></input>
                  </div>
                </div>
              </form>
            </div>

            <div class="modal-footer">
              <button rest="/api/hardware/rack/{{ site }}/{{ editRack.name }}" rest-method="post" rest-data="editRack" rest-success="reload(); editRack=null" class="btn btn-primary">Save</button>
              <button class="btn btn-danger" ng-click="editRack=null; close()">Cancel</button>
            </div>
          </div>

        </pane>
      </tabs>
    </div>
  </div>
</div>

<!-- rack unit view -->
<div class="modal" ng-show="opt.current_unit">
  <div class="modal-header">
    <h3>{{ opt.current_unit.site | uppercase }}: Rack {{ opt.current_unit.rack.name }}, U{{ opt.current_unit.unit.unit | min }}</h3>
  </div>

  <div class="modal-body">
    <dl>
      <dt>Model</dt>
      <dd>{{ opt.current_unit.unit.make }} {{ opt.current_unit.unit.model }}</dd>
    </dl>

    <table class="table table-hover">
      <thead>
        <tr>
          <th ng-click="sortField='properties.slot'; sortReverse=!sortReverse">Slot</th>
          <th ng-click="sortField='id'; sortReverse=!sortReverse">ID</th>
          <th ng-click="sortField='status'; sortReverse=!sortReverse" class="center"><abbr title="Status">S</abbr></th>
          <th ng-click="sortField='properties.alert_state'; sortReverse=!sortReverse" class="center"><abbr title="Alerts"><i class="icon-warning-sign"></i></abbr></th>
          <th ng-click="sortField='name'; sortReverse=!sortReverse">Name</th>
          <th ng-click="sortField='properties.ip'; sortReverse=!sortReverse">Primary IP</th>
          <th ng-click="sortField='collected_at'; sortReverse=!sortReverse">Last Seen</th>
        </tr>
      </thead>

      <tbody>
        <tr ng-repeat="node in opt.current_unit.unit.nodes | orderBy:'properties.slot'" class="{{ node.name == null &amp;&amp; 'error' }}">
          <td><b>{{ node.properties.slot || ' ' }}</b></td>
          <td><a ng-show="node.id" target="_blank" href="#/node/{{node.id}}">{{ node.id }}</a></td>
          <td>
            <i class="icon icon-circle text-{{node.status}}" title="{{node.status|titleize}}"> </i>
          </td>
          <td>
            <i ng-show="node.properties.alert_state" class="icon icon-circle text-{{node.properties.alert_state}}" title="{{node.properties.alert_state|titleize}}"> </i>
          </td>
          <td>
            <span ng-show="node.name">{{ node.name }}</span>
            <span ng-hide="node.name"><i>missing</i></span>
          </td>
          <td>{{ node.properties.ip }}</td>
          <td>
            <span ng-show="node.collected_at">{{ node.collected_at | timeAgo }}</span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="modal-footer">
    <button class="btn btn-danger" ng-click="opt.current_unit=null">Close</button>
  </div>
</div>