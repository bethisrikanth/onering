<div class="container-fluid node" ng-show="device">
  <header class="row-fluid">
    <div class="span9">
      <span class="label label-{{ device.status || 'unknown' }} hid">ID: <a target="_blank" href="/api/devices/{{ device.id }}">{{ device.id }}</a></span>
      <span class="label label-{{ device.status || 'unknown' }} status" ng-show="device.status"><a open-dialog="nodeTransitionState">{{ device.status | titleize }}</a></span>
      <span class="label" ng-show="device.maintenance_status"><i class="icon-{{ device.maintenance_status }} icon-white"></i> Needs {{ device.maintenance_status | titleize }}</span>
      <span class="label label-important" ng-show="device.properties.monitor==false">Monitoring Disabled</span>
      <br />
      <h1>
        <span class="name">{{ device.name | section:'.':0:1 }}<i class="minor">.{{ device.name | section:'.':1 }}</i></span>
      </h1>
      <div ng-show="device.parent_id"><b> Parent:</b> <a href="#/node/{{ device.parent_id }}">{{ device.parent_id }}</a></div>
      <div ng-show="device.aliases"><b> Aliases:</b> {{ device.aliases | join:', ' }}</div>
      <div ng-show="device.tags" class="tags">
        <b>Tags:</b>
        <span>
          <span ng-repeat="tag in device.tags">
            <span class="label label-inverse">
              {{ tag }}
              <a style="color: white; text-decoration: none" ng-click="untag(tag)">&times;</a>
            </span>
          </span>
        </span>

        <a class="add" open-dialog="tagEditor" ng-click="newtags.push('')"><i class="icon-plus-sign"></i></a>
      </div>
    </div>

    <div class="span3">
      <button class="btn btn-success pull-right" ng-click="reload()"><i class="icon-refresh icon-white"></i> Reload</button>
      <br />
      <br />
      <div>
        <b>
            <i class="icon-time"></i>
          Node Seen: <span ng-show="device.collected_at">{{ device.collected_at | timeAgo }}</span><span ng-hide="device.collected_at">has not reported</span>
        </b>
        <br />
        <b>
          <i class="icon-refresh"></i>
          Refreshed: {{ load_time | timeAgo }}
        </b>
      </div>
    </div>
  </header>

  <div class="row-fluid">
    <div class="span3">
      <h3>Details</h3>
      <div ng-include="'views/node-details.html'" />
    </div>

    <div class="span6" ng-include="'views/node-dashboard.html'" />

    <div class="span3">
      <h3>Notes</h3>

      <ul class="nav nav-list">
        <li><a open-dialog="nodeComment"><i class="icon-comment"></i> Add Note</a></li>
        <li class="divider"></li>
        <li>
          <div class="alert alert-info" ng-repeat="(time, note) in device.properties.notes | orderBy:'id':true" id="note-{{ time }}">
            <button type="button" class="close" ng-click="deleteNote(time)">&times;</button>
            <button type="button" class="close" open-dialog="nodeComment" ng-click="editNote(time)"><i title="Edit" class="icon-pencil"></i>&nbsp;</button>
            <span class="pull-left"><b>{{ note.user_id }}</b> ({{ (time*1000) | date:'short' }}):</span></span><br />
            <span>{{ note.body }}</span>
          </div>
        </li>
      </ul>

      <h3>Actions</h3>

      <ul class="nav nav-list well">
        <li class="nav-header">Lifecycle</li>
        <li><a open-dialog="nodeTransitionState"><i class="icon-retweet"></i> Transition to State</a></li>
        <li><a open-dialog="nodeTransitionMaintState"><i class="icon-wrench"></i> Maintenance Status</a></li>
        <li><a open-dialog="nodeRedeploy"><i class="icon-repeat"></i> Redeploy Node</a></li>

        <li class="nav-header">Operations</li>
        <li ng-show="device.properties.monitor==false"><a ng-click="setProperty('monitor', 'true')"><i class="icon-tasks"></i> Resume Monitoring</a></li>
        <li ng-show="device.properties.monitor==true"><a ng-click="setProperty('monitor', 'false')"><i class="icon-stop"></i> Suspend Monitoring</a></li>

        <li class="nav-header">Metadata</li>
        <!-- <li><a><i class="icon-book"></i> Update Inventory</a></li> -->
        <li><a open-dialog="nodeDeleteConfirm"><i class="icon-trash"></i> Delete Node</a></li>
        <li ng-hide="showProvisioning"><a ng-click="showProvisioning=!showProvisioning"><i class="icon-list"></i> Show Provisioning Data</a></li>
        <li ng-show="showProvisioning"><a ng-click="showProvisioning=!showProvisioning"><i class="icon-list"></i> Hide Provisioning Data</a></li>
      </ul>

      <div ng-show="device.status=='provisioning' || device.status=='installing' || showProvisioning" ng-controller="ProvisioningNodeController">
        <h3>Provisioning</h3>

        <table class="table table-condensed">
          <tbody>
            <tr ng-show="device.properties.provisioning.hostname">
              <th>Hostname</th>
              <td>{{ device.properties.provisioning.hostname | section:'.':0:1 }}</td>
            </tr>

            <tr ng-show="device.properties.provisioning.hostname">
              <th>Domain</th>
              <td>{{ device.properties.provisioning.hostname | section:'.':1 }}</td>
            </tr>

            <tr ng-show="device.properties.provisioning.network.ip">
              <th>IP</th>
              <td>{{ device.properties.provisioning.network.ip }}</td>
            </tr>

            <tr ng-show="device.properties.provisioning.network.netmask">
              <th>Mask</th>
              <td>{{ device.properties.provisioning.network.netmask }}</td>
            </tr>

            <tr ng-show="device.properties.provisioning.network.gateway">
              <th>Gateway</th>
              <td>{{ device.properties.provisioning.network.gateway }}</td>
            </tr>

            <tr ng-show="device.properties.provisioning.network.dns">
              <th>DNS 1</th>
              <td>{{ device.properties.provisioning.network.dns }}</td>
            </tr>
          </tbody>
        </table>

        <ul class="nav nav-list well">
          <li class="nav-header">Actions</li>
          <li><a target="_blank" href="/api/provision/{{ device.id }}"><i class="icon-list-alt"></i> View Installation Script</a></li>
          <li><a target="_blank" href="/api/provision/{{ device.id }}/boot"><i class="icon-hdd"></i> View PXE Boot Configuration</a></li>

          <li class="nav-header">
            Reboot to Profile
            <span ng-show="device.properties.provisioning.action">(Next Action: {{ device.properties.provisioning.action }})</span>
          </li>
          <li ng-show="device.properties.provisioning.action"><a ng-click="setNextAction('clear')"><i class="icon-remove-circle"></i> Clear Next Action</a></li>
          <li><a ng-click="setNextAction('reboot:razor')"><i class="icon-check"></i> Razor</a></li>
          <li><a ng-click="setNextAction('reboot:install')"><i class="icon-fire"></i> Installer</a></li>
          <li><a ng-click="setNextAction('reboot:local')"><i class="icon-hdd"></i> Local</a></li>
        </ul>
      </ul>
    </div>
  </div>

</div>

<div class="modal hide" id="nodeComment">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h3>Add Note</h3>
  </div>

  <div class="modal-body">
    <textarea autofocus style="width: 95%;" ng-model="note"></textarea>
  </div>

  <div class="modal-footer">
    <a class="btn btn-danger" data-dismiss="modal" ng-click="note=null">Cancel</a>
    <a class="btn btn-primary" data-dismiss="modal" ng-click="saveNote(old_note_id)">Save</a>
  </div>
</div>

<div class="modal hide" id="nodeTransitionState">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h3>Transition to State</h3>
  </div>

  <div class="modal-body">
    <ul class="nav nav-list status">
      <li>
        <a ng-click="setStatus('online')" data-dismiss="modal">
          <span class="name"><img src="/img/status/online.png" title="Online" /> Online</span>
          <span>Mark a node as online and active</span>
        </a>
      </li>
      <li>
        <a ng-click="setStatus('reserved')" data-dismiss="modal">
          <span class="name"><img src="/img/status/reserved.png" title="Reserved" /> Reserved</span>
          <span>Reserve this node for a special purpose outside of typical Production or R&amp;D services</span>
        </a>
      </li>
      <li>
        <a ng-click="setStatus('allocatable')" data-dismiss="modal">
          <span class="name"><img src="/img/status/allocatable.png" title="Allocatable" /> Allocatable</span>
          <span>Flag this node as free to be reinstalled and used for another role</span>
        </a>
      </li>
      <li>
        <a ng-click="setStatus('unknown')" data-dismiss="modal">
          <span class="name"><img src="/img/status/unknown.png" title="Unknown" /> Unknown</span>
          <span>The status is not known (will automatically return to online when it reports)</span>
        </a>
      </li>
    </ul>
  </div>

  <div class="modal-footer">
    <a class="btn" data-dismiss="modal">Close</a>
  </div>
</div>


<div class="modal hide" id="nodeTransitionMaintState">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h3>Maintenance Status</h3>
  </div>

  <div class="modal-body">
    <ul class="nav nav-list status">
      <li>
        <a ng-click="setMaintStatus('healthy')" data-dismiss="modal">
          <span class="name"><i class="icon-ok"></i> Healthy</span>
          <span>All problems fixed, no known issues</span>
        </a>
      </li>
      <li>
        <a ng-click="setMaintStatus('parts')" data-dismiss="modal">
          <span class="name"><i class="icon-parts"></i> Needs Parts</span>
          <span>Something is physically broken and needs to be replaced</span>
        </a>
      </li>
      <li>
        <a ng-click="setMaintStatus('service')" data-dismiss="modal">
          <span class="name"><i class="icon-service"></i> Needs Service</span>
          <span>Requires some form of manual intervention to get the node to a healthy state</span>
        </a>
      </li>
    </ul>
  </div>

  <div class="modal-footer">
    <a class="btn" data-dismiss="modal">Close</a>
  </div>
</div>


<div class="modal hide" id="tagEditor">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h3>Add Tags</h3>
  </div>

  <div class="modal-body">
    <form name="tags">
      <input
        ng-repeat="tag in newtags"
        type="text"
        name="tag0"
        autofocus
        ng-model="newtags[$index]">
      </input>
    </form>
  </div>

  <div class="modal-footer">
    <a class="btn" data-dismiss="modal">Close</a>
    <a class="btn btn-primary" data-dismiss="modal" ng-click="saveTags()">Save</a>
  </div>
</div>


<div class="modal hide" id="nodeDeleteConfirm">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h3>Confirm Delete</h3>
  </div>

  <div class="modal-body">
    Are you sure you want to delete this node?  All data associated with this node will be permanently removed.
    <br />
    <br />
    <b>If you are sure, type the node's Hardware ID below (case sensitive):</b>
    <br />
    <br />
    <input type="text" ng-model="deleteConfirmId"></input>
  </div>

  <div class="modal-footer">
    <a class="btn" data-dismiss="modal">Cancel</a>
    <a class="btn btn-danger" data-dismiss="modal" ng-click="deleteNode()">Delete</a>
  </div>
</div>


<div class="modal hide" id="nodeRedeploy">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h3>Confirm Node Redeploy</h3>
  </div>

  <div class="modal-body">
    Are you sure you want to redeploy this node?  <b style="color: red">THIS IS WILL DESTROY THE PHYSICAL DATA ON THE MACHINE!</b>
    <br />
    <br />
    <h5>Before continuing, please be sure to:</h5>
    <ul>
      <li>Delete the Chef client for this node: <tt>knife client delete {{ device.name }}</tt></li>
    </ul>
    <br />
    <b>If you are sure, type the node's Hardware ID below (case sensitive):</b>
    <br />
    <br />
    <input type="text" ng-model="redeployConfirmId"></input>
  </div>

  <div class="modal-footer">
    <a class="btn" data-dismiss="modal">Cancel</a>
    <a class="btn btn-danger" data-dismiss="modal" ng-click="redeployNode()">Redeploy</a>
  </div>
</div>
